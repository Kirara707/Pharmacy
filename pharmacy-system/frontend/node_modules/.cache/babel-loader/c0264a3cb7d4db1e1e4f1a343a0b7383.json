{"remainingRequest":"C:\\Users\\lizhe\\Desktop\\database\\pharmacy-system\\frontend\\node_modules\\babel-loader\\lib\\index.js!C:\\Users\\lizhe\\Desktop\\database\\pharmacy-system\\frontend\\node_modules\\cache-loader\\dist\\cjs.js??ref--1-0!C:\\Users\\lizhe\\Desktop\\database\\pharmacy-system\\frontend\\node_modules\\vue-loader-v16\\dist\\index.js??ref--1-1!C:\\Users\\lizhe\\Desktop\\database\\pharmacy-system\\frontend\\src\\views\\Sales.vue?vue&type=script&lang=js","dependencies":[{"path":"C:\\Users\\lizhe\\Desktop\\database\\pharmacy-system\\frontend\\src\\views\\Sales.vue","mtime":1750158932165},{"path":"C:\\Users\\lizhe\\Desktop\\database\\pharmacy-system\\frontend\\babel.config.js","mtime":1750140439609},{"path":"C:\\Users\\lizhe\\Desktop\\database\\pharmacy-system\\frontend\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1750139103810},{"path":"C:\\Users\\lizhe\\Desktop\\database\\pharmacy-system\\frontend\\node_modules\\babel-loader\\lib\\index.js","mtime":1750139103814},{"path":"C:\\Users\\lizhe\\Desktop\\database\\pharmacy-system\\frontend\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1750139103810},{"path":"C:\\Users\\lizhe\\Desktop\\database\\pharmacy-system\\frontend\\node_modules\\vue-loader-v16\\dist\\index.js","mtime":1750139102365}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuaXRlcmF0b3IuY29uc3RydWN0b3IuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5pdGVyYXRvci5maW5kLmpzIjsKaW1wb3J0IHsgcmVmLCByZWFjdGl2ZSwgY29tcHV0ZWQsIG9uTW91bnRlZCB9IGZyb20gJ3Z1ZSc7CmltcG9ydCB7IHVzZVN0b3JlIH0gZnJvbSAndnVleCc7CmltcG9ydCB7IEVsTWVzc2FnZSwgRWxNZXNzYWdlQm94IH0gZnJvbSAnZWxlbWVudC1wbHVzJzsKaW1wb3J0IGF4aW9zIGZyb20gJ2F4aW9zJzsKZXhwb3J0IGRlZmF1bHQgewogIG5hbWU6ICdTYWxlcycsCiAgc2V0dXAoKSB7CiAgICBjb25zdCBzdG9yZSA9IHVzZVN0b3JlKCk7CiAgICBjb25zdCBsb2FkaW5nID0gcmVmKGZhbHNlKTsKICAgIGNvbnN0IGRpYWxvZ1Zpc2libGUgPSByZWYoZmFsc2UpOwogICAgY29uc3Qgc3VibWl0TG9hZGluZyA9IHJlZihmYWxzZSk7CiAgICBjb25zdCBzYWxlRm9ybVJlZiA9IHJlZihudWxsKTsKICAgIGNvbnN0IHNhbGVGb3JtID0gcmVhY3RpdmUoewogICAgICBtZWRpY2luZV9pZDogJycsCiAgICAgIHF1YW50aXR5OiAxCiAgICB9KTsKICAgIGNvbnN0IHJ1bGVzID0gewogICAgICBtZWRpY2luZV9pZDogW3sKICAgICAgICByZXF1aXJlZDogdHJ1ZSwKICAgICAgICBtZXNzYWdlOiAn6K+36YCJ5oup6I2v5ZOBJywKICAgICAgICB0cmlnZ2VyOiAnY2hhbmdlJwogICAgICB9XSwKICAgICAgcXVhbnRpdHk6IFt7CiAgICAgICAgcmVxdWlyZWQ6IHRydWUsCiAgICAgICAgbWVzc2FnZTogJ+ivt+i+k+WFpeaVsOmHjycsCiAgICAgICAgdHJpZ2dlcjogJ2JsdXInCiAgICAgIH0sIHsKICAgICAgICB0eXBlOiAnbnVtYmVyJywKICAgICAgICBtaW46IDEsCiAgICAgICAgbWVzc2FnZTogJ+aVsOmHj+W/hemhu+Wkp+S6jjAnLAogICAgICAgIHRyaWdnZXI6ICdibHVyJwogICAgICB9XQogICAgfTsKICAgIGNvbnN0IHNhbGVzID0gY29tcHV0ZWQoKCkgPT4gc3RvcmUuc3RhdGUuc2FsZXMubGlzdCk7CiAgICBjb25zdCBtZWRpY2luZXMgPSBjb21wdXRlZCgoKSA9PiBzdG9yZS5zdGF0ZS5tZWRpY2luZXMubGlzdCk7CiAgICBjb25zdCB1c2VyUm9sZSA9IGNvbXB1dGVkKCgpID0+IHsKICAgICAgdmFyIF9zdG9yZSRzdGF0ZSRhdXRoJHVzZTsKICAgICAgcmV0dXJuIChfc3RvcmUkc3RhdGUkYXV0aCR1c2UgPSBzdG9yZS5zdGF0ZS5hdXRoLnVzZXIpID09PSBudWxsIHx8IF9zdG9yZSRzdGF0ZSRhdXRoJHVzZSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX3N0b3JlJHN0YXRlJGF1dGgkdXNlLnJvbGU7CiAgICB9KTsKICAgIGNvbnN0IGNhbkFkZFNhbGUgPSBjb21wdXRlZCgoKSA9PiB7CiAgICAgIHJldHVybiBbJ2FkbWluJywgJ3NhbGVzcGVyc29uJywgJ3BoYXJtYWN5X2FkbWluJ10uaW5jbHVkZXModXNlclJvbGUudmFsdWUpOwogICAgfSk7CiAgICBjb25zdCBjYW5FZGl0U2FsZSA9IGNvbXB1dGVkKCgpID0+IHsKICAgICAgcmV0dXJuIFsnYWRtaW4nLCAnc2FsZXNwZXJzb24nLCAncGhhcm1hY3lfYWRtaW4nXS5pbmNsdWRlcyh1c2VyUm9sZS52YWx1ZSk7CiAgICB9KTsKICAgIGNvbnN0IHNlbGVjdGVkTWVkaWNpbmUgPSBjb21wdXRlZCgoKSA9PiB7CiAgICAgIHJldHVybiBtZWRpY2luZXMudmFsdWUuZmluZChtID0+IG0uaWQgPT09IHNhbGVGb3JtLm1lZGljaW5lX2lkKTsKICAgIH0pOwogICAgY29uc3QgZ2V0TWF4UXVhbnRpdHkgPSBjb21wdXRlZCgoKSA9PiB7CiAgICAgIHJldHVybiBzZWxlY3RlZE1lZGljaW5lLnZhbHVlID8gc2VsZWN0ZWRNZWRpY2luZS52YWx1ZS5zdG9jayA6IDA7CiAgICB9KTsKICAgIGNvbnN0IGZldGNoU2FsZXMgPSBhc3luYyAoKSA9PiB7CiAgICAgIHRyeSB7CiAgICAgICAgbG9hZGluZy52YWx1ZSA9IHRydWU7CiAgICAgICAgYXdhaXQgc3RvcmUuZGlzcGF0Y2goJ3NhbGVzL2ZldGNoU2FsZXMnKTsKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBFbE1lc3NhZ2UuZXJyb3IoZXJyb3IubWVzc2FnZSk7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgbG9hZGluZy52YWx1ZSA9IGZhbHNlOwogICAgICB9CiAgICB9OwogICAgY29uc3QgZmV0Y2hNZWRpY2luZXMgPSBhc3luYyAoKSA9PiB7CiAgICAgIHRyeSB7CiAgICAgICAgYXdhaXQgc3RvcmUuZGlzcGF0Y2goJ21lZGljaW5lcy9mZXRjaE1lZGljaW5lcycpOwogICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgIEVsTWVzc2FnZS5lcnJvcihlcnJvci5tZXNzYWdlKTsKICAgICAgfQogICAgfTsKICAgIGNvbnN0IHNob3dBZGREaWFsb2cgPSAoKSA9PiB7CiAgICAgIGNvbnNvbGUubG9nKCfmmL7npLrmt7vliqDplIDllK7orrDlvZXlr7nor53moYYnKTsKICAgICAgY29uc29sZS5sb2coJ+W9k+WJjeeUqOaIt+inkuiJsjonLCB1c2VyUm9sZS52YWx1ZSk7CiAgICAgIGNvbnNvbGUubG9nKCflj6/mt7vliqDplIDllK7orrDlvZU6JywgY2FuQWRkU2FsZS52YWx1ZSk7CiAgICAgIGNvbnNvbGUubG9nKCfoja/lk4HliJfooag6JywgbWVkaWNpbmVzLnZhbHVlKTsKCiAgICAgIC8vIOmHjee9ruihqOWNleaVsOaNrgogICAgICBPYmplY3QuYXNzaWduKHNhbGVGb3JtLCB7CiAgICAgICAgbWVkaWNpbmVfaWQ6ICcnLAogICAgICAgIHF1YW50aXR5OiAxCiAgICAgIH0pOwogICAgICBkaWFsb2dWaXNpYmxlLnZhbHVlID0gdHJ1ZTsKICAgICAgLy8g5riF6Zmk6KGo5Y2V6aqM6K+BCiAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgIGlmIChzYWxlRm9ybVJlZi52YWx1ZSkgewogICAgICAgICAgc2FsZUZvcm1SZWYudmFsdWUuY2xlYXJWYWxpZGF0ZSgpOwogICAgICAgIH0KICAgICAgfSwgMTAwKTsKICAgIH07CiAgICBjb25zdCBoYW5kbGVEZWxldGUgPSBhc3luYyByb3cgPT4gewogICAgICB0cnkgewogICAgICAgIGF3YWl0IEVsTWVzc2FnZUJveC5jb25maXJtKCfnoa7lrpropoHliKDpmaTov5nmnaHplIDllK7orrDlvZXlkJfvvJ/liKDpmaTlkI7lsIbmgaLlpI3lr7nlupTnmoToja/lk4HlupPlrZjjgIInLCAn6K2m5ZGKJywgewogICAgICAgICAgdHlwZTogJ3dhcm5pbmcnCiAgICAgICAgfSk7CiAgICAgICAgY29uc3QgdG9rZW4gPSBzdG9yZS5zdGF0ZS5hdXRoLnRva2VuOwogICAgICAgIGNvbnN0IGNvbmZpZyA9IHsKICAgICAgICAgIGhlYWRlcnM6IHsKICAgICAgICAgICAgJ0F1dGhvcml6YXRpb24nOiBgQmVhcmVyICR7dG9rZW59YAogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgYXdhaXQgYXhpb3MuZGVsZXRlKGBodHRwOi8vbG9jYWxob3N0OjUwMDAvYXBpL3NhbGVzLyR7cm93LmlkfWAsIGNvbmZpZyk7CiAgICAgICAgRWxNZXNzYWdlLnN1Y2Nlc3MoJ+WIoOmZpOaIkOWKn++8jOW6k+WtmOW3suaBouWkjScpOwogICAgICAgIGZldGNoU2FsZXMoKTsKICAgICAgICBmZXRjaE1lZGljaW5lcygpOyAvLyDliLfmlrDoja/lk4HlupPlrZgKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBpZiAoZXJyb3IgIT09ICdjYW5jZWwnKSB7CiAgICAgICAgICB2YXIgX2Vycm9yJHJlc3BvbnNlLCBfZXJyb3IkcmVzcG9uc2UkZGF0YTsKICAgICAgICAgIEVsTWVzc2FnZS5lcnJvcigoKF9lcnJvciRyZXNwb25zZSA9IGVycm9yLnJlc3BvbnNlKSA9PT0gbnVsbCB8fCBfZXJyb3IkcmVzcG9uc2UgPT09IHZvaWQgMCA/IHZvaWQgMCA6IChfZXJyb3IkcmVzcG9uc2UkZGF0YSA9IF9lcnJvciRyZXNwb25zZS5kYXRhKSA9PT0gbnVsbCB8fCBfZXJyb3IkcmVzcG9uc2UkZGF0YSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Vycm9yJHJlc3BvbnNlJGRhdGEubWVzc2FnZSkgfHwgJ+WIoOmZpOWksei0pScpOwogICAgICAgIH0KICAgICAgfQogICAgfTsKICAgIGNvbnN0IGhhbmRsZVN1Ym1pdCA9IGFzeW5jICgpID0+IHsKICAgICAgaWYgKCFzYWxlRm9ybVJlZi52YWx1ZSkgewogICAgICAgIEVsTWVzc2FnZS5lcnJvcign6KGo5Y2V5byV55So5LiN5a2Y5ZyoJyk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIHRyeSB7CiAgICAgICAgLy8g6aqM6K+B6KGo5Y2VCiAgICAgICAgYXdhaXQgc2FsZUZvcm1SZWYudmFsdWUudmFsaWRhdGUoKTsKCiAgICAgICAgLy8g5qOA5p+l5b+F6KaB5pWw5o2uCiAgICAgICAgaWYgKCFzYWxlRm9ybS5tZWRpY2luZV9pZCkgewogICAgICAgICAgRWxNZXNzYWdlLmVycm9yKCfor7fpgInmi6noja/lk4EnKTsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKCFzYWxlRm9ybS5xdWFudGl0eSB8fCBzYWxlRm9ybS5xdWFudGl0eSA8PSAwKSB7CiAgICAgICAgICBFbE1lc3NhZ2UuZXJyb3IoJ+ivt+i+k+WFpeacieaViOeahOaVsOmHjycpOwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zb2xlLmxvZygn5o+Q5Lqk6ZSA5ZSu6K6w5b2VOicsIHNhbGVGb3JtKTsKICAgICAgICBzdWJtaXRMb2FkaW5nLnZhbHVlID0gdHJ1ZTsKCiAgICAgICAgLy8g6K6+572u6K+35rGC5aS0CiAgICAgICAgY29uc3QgdG9rZW4gPSBzdG9yZS5zdGF0ZS5hdXRoLnRva2VuOwogICAgICAgIGlmICghdG9rZW4pIHsKICAgICAgICAgIEVsTWVzc2FnZS5lcnJvcign55So5oi35pyq55m75b2VJyk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGNvbmZpZyA9IHsKICAgICAgICAgIGhlYWRlcnM6IHsKICAgICAgICAgICAgJ0F1dGhvcml6YXRpb24nOiBgQmVhcmVyICR7dG9rZW59YCwKICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBheGlvcy5wb3N0KCdodHRwOi8vbG9jYWxob3N0OjUwMDAvYXBpL3NhbGVzJywgc2FsZUZvcm0sIGNvbmZpZyk7CiAgICAgICAgY29uc29sZS5sb2coJ+mUgOWUruiusOW9leWIm+W7uuWTjeW6lDonLCByZXNwb25zZS5kYXRhKTsKICAgICAgICBFbE1lc3NhZ2Uuc3VjY2Vzcygn6ZSA5ZSu6K6w5b2V5re75Yqg5oiQ5YqfJyk7CiAgICAgICAgZGlhbG9nVmlzaWJsZS52YWx1ZSA9IGZhbHNlOwogICAgICAgIGF3YWl0IGZldGNoU2FsZXMoKTsKICAgICAgICBhd2FpdCBmZXRjaE1lZGljaW5lcygpOyAvLyDliLfmlrDoja/lk4HlupPlrZgKICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCfmj5DkuqTplJnor686JywgZXJyb3IpOwogICAgICAgIGlmIChlcnJvci5yZXNwb25zZSkgewogICAgICAgICAgdmFyIF9lcnJvciRyZXNwb25zZSRkYXRhMjsKICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ+mUmeivr+WTjeW6lDonLCBlcnJvci5yZXNwb25zZS5kYXRhKTsKICAgICAgICAgIEVsTWVzc2FnZS5lcnJvcigoKF9lcnJvciRyZXNwb25zZSRkYXRhMiA9IGVycm9yLnJlc3BvbnNlLmRhdGEpID09PSBudWxsIHx8IF9lcnJvciRyZXNwb25zZSRkYXRhMiA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2Vycm9yJHJlc3BvbnNlJGRhdGEyLm1lc3NhZ2UpIHx8ICfmk43kvZzlpLHotKUnKTsKICAgICAgICB9IGVsc2UgaWYgKGVycm9yLm1lc3NhZ2UpIHsKICAgICAgICAgIEVsTWVzc2FnZS5lcnJvcihlcnJvci5tZXNzYWdlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgRWxNZXNzYWdlLmVycm9yKCfor7fmo4Dmn6XovpPlhaXmmK/lkKbmraPnoa4nKTsKICAgICAgICB9CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgc3VibWl0TG9hZGluZy52YWx1ZSA9IGZhbHNlOwogICAgICB9CiAgICB9OwogICAgb25Nb3VudGVkKCgpID0+IHsKICAgICAgZmV0Y2hTYWxlcygpOwogICAgICBmZXRjaE1lZGljaW5lcygpOwogICAgfSk7CiAgICByZXR1cm4gewogICAgICBsb2FkaW5nLAogICAgICBzYWxlcywKICAgICAgbWVkaWNpbmVzLAogICAgICBkaWFsb2dWaXNpYmxlLAogICAgICBzYWxlRm9ybSwKICAgICAgc2FsZUZvcm1SZWYsCiAgICAgIHJ1bGVzLAogICAgICBjYW5BZGRTYWxlLAogICAgICBjYW5FZGl0U2FsZSwKICAgICAgc2VsZWN0ZWRNZWRpY2luZSwKICAgICAgZ2V0TWF4UXVhbnRpdHksCiAgICAgIHNob3dBZGREaWFsb2csCiAgICAgIGhhbmRsZURlbGV0ZSwKICAgICAgaGFuZGxlU3VibWl0LAogICAgICBzdWJtaXRMb2FkaW5nCiAgICB9OwogIH0KfTs="},{"version":3,"names":["ref","reactive","computed","onMounted","useStore","ElMessage","ElMessageBox","axios","name","setup","store","loading","dialogVisible","submitLoading","saleFormRef","saleForm","medicine_id","quantity","rules","required","message","trigger","type","min","sales","state","list","medicines","userRole","_store$state$auth$use","auth","user","role","canAddSale","includes","value","canEditSale","selectedMedicine","find","m","id","getMaxQuantity","stock","fetchSales","dispatch","error","fetchMedicines","showAddDialog","console","log","Object","assign","setTimeout","clearValidate","handleDelete","row","confirm","token","config","headers","delete","success","_error$response","_error$response$data","response","data","handleSubmit","validate","post","_error$response$data2"],"sources":["C:\\Users\\lizhe\\Desktop\\database\\pharmacy-system\\frontend\\src\\views\\Sales.vue"],"sourcesContent":["<template>\r\n  <div class=\"sales-container\">\r\n    <div class=\"header\">\r\n      <h2>销售记录</h2>\r\n      <el-button type=\"primary\" @click=\"showAddDialog\" v-if=\"canAddSale\">\r\n        新增销售记录\r\n      </el-button>\r\n    </div>\r\n\r\n    <el-table\r\n      v-loading=\"loading\"\r\n      :data=\"sales\"\r\n      style=\"width: 100%\">\r\n      <el-table-column prop=\"id\" label=\"记录ID\" width=\"100\" />\r\n      <el-table-column prop=\"medicine_name\" label=\"药品名称\" />\r\n      <el-table-column prop=\"quantity\" label=\"数量\" />\r\n      <el-table-column prop=\"total_price\" label=\"总价\">\r\n        <template #default=\"scope\">\r\n          ¥{{ scope.row.total_price.toFixed(2) }}\r\n        </template>\r\n      </el-table-column>\r\n      <el-table-column prop=\"created_at\" label=\"销售时间\">\r\n        <template #default=\"scope\">\r\n          {{ new Date(scope.row.created_at).toLocaleString() }}\r\n        </template>\r\n      </el-table-column>\r\n      <el-table-column label=\"操作\" v-if=\"canEditSale\">\r\n        <template #default=\"scope\">\r\n          <el-button\r\n            size=\"small\"\r\n            type=\"danger\"\r\n            @click=\"handleDelete(scope.row)\">\r\n            删除\r\n          </el-button>\r\n        </template>\r\n      </el-table-column>\r\n    </el-table>\r\n\r\n    <!-- 添加销售记录对话框 -->\r\n    <el-dialog\r\n      title=\"新增销售记录\"\r\n      v-model=\"dialogVisible\"\r\n      width=\"500px\">\r\n      <el-form\r\n        :model=\"saleForm\"\r\n        :rules=\"rules\"\r\n        ref=\"saleFormRef\"\r\n        label-width=\"100px\">\r\n        <el-form-item label=\"药品\" prop=\"medicine_id\">\r\n          <el-select\r\n            v-model=\"saleForm.medicine_id\"\r\n            placeholder=\"请选择药品\"\r\n            style=\"width: 100%\"\r\n            filterable\r\n            clearable>\r\n            <el-option\r\n              v-for=\"medicine in medicines\"\r\n              :key=\"medicine.id\"\r\n              :label=\"medicine.name\"\r\n              :value=\"medicine.id\"\r\n              :disabled=\"medicine.stock === 0\">\r\n              <span>{{ medicine.name }}</span>\r\n              <span style=\"float: right; font-size: 13px\" \r\n                    :style=\"{ color: medicine.stock > 0 ? '#67C23A' : '#F56C6C' }\">\r\n                库存: {{ medicine.stock }}{{ medicine.stock === 0 ? ' (缺货)' : '' }}\r\n              </span>\r\n            </el-option>\r\n          </el-select>\r\n        </el-form-item>\r\n        <el-form-item label=\"数量\" prop=\"quantity\">\r\n          <el-input-number\r\n            v-model=\"saleForm.quantity\"\r\n            :min=\"1\"\r\n            :max=\"Math.max(1, getMaxQuantity)\"\r\n            :precision=\"0\"\r\n            :disabled=\"!selectedMedicine || getMaxQuantity === 0\"\r\n            style=\"width: 100%\"\r\n            :placeholder=\"selectedMedicine ? '请输入销售数量' : '请先选择药品'\" />\r\n          <div v-if=\"!selectedMedicine\" style=\"color: #909399; font-size: 12px; margin-top: 4px;\">\r\n            请先选择要销售的药品\r\n          </div>\r\n          <div v-else-if=\"getMaxQuantity === 0\" style=\"color: #F56C6C; font-size: 12px; margin-top: 4px;\">\r\n            该药品库存不足，无法销售\r\n          </div>\r\n        </el-form-item>\r\n        <el-form-item label=\"库存信息\" v-if=\"selectedMedicine\">\r\n          <div style=\"margin-bottom: 8px;\">\r\n            <span style=\"color: #909399;\">当前库存: </span>\r\n            <span :style=\"{ color: getMaxQuantity > 0 ? '#67C23A' : '#F56C6C', fontWeight: 'bold' }\">\r\n              {{ getMaxQuantity }} 件\r\n            </span>\r\n          </div>\r\n        </el-form-item>\r\n        <el-form-item label=\"预计总价\" v-if=\"selectedMedicine && saleForm.quantity > 0\">\r\n          <div style=\"font-size: 16px; color: #409EFF; font-weight: bold;\">\r\n            ¥{{ (selectedMedicine.price * saleForm.quantity).toFixed(2) }}\r\n          </div>\r\n        </el-form-item>\r\n      </el-form>\r\n      <template #footer>\r\n        <span class=\"dialog-footer\">\r\n          <el-button @click=\"dialogVisible = false\">取消</el-button>\r\n          <el-button type=\"primary\" :loading=\"submitLoading\" @click=\"handleSubmit\">\r\n            确定\r\n          </el-button>\r\n        </span>\r\n      </template>\r\n    </el-dialog>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nimport { ref, reactive, computed, onMounted } from 'vue'\r\nimport { useStore } from 'vuex'\r\nimport { ElMessage, ElMessageBox } from 'element-plus'\r\nimport axios from 'axios'\r\n\r\nexport default {\r\n  name: 'Sales',\r\n  setup() {\r\n    const store = useStore()\r\n    const loading = ref(false)\r\n    const dialogVisible = ref(false)\r\n    const submitLoading = ref(false)\r\n    const saleFormRef = ref(null)\r\n    const saleForm = reactive({\r\n      medicine_id: '',\r\n      quantity: 1\r\n    })\r\n\r\n    const rules = {\r\n      medicine_id: [\r\n        { required: true, message: '请选择药品', trigger: 'change' }\r\n      ],\r\n      quantity: [\r\n        { required: true, message: '请输入数量', trigger: 'blur' },\r\n        { type: 'number', min: 1, message: '数量必须大于0', trigger: 'blur' }\r\n      ]\r\n    }\r\n\r\n    const sales = computed(() => store.state.sales.list)\r\n    const medicines = computed(() => store.state.medicines.list)\r\n    const userRole = computed(() => store.state.auth.user?.role)\r\n\r\n    const canAddSale = computed(() => {\r\n      return ['admin', 'salesperson', 'pharmacy_admin'].includes(userRole.value)\r\n    })\r\n\r\n    const canEditSale = computed(() => {\r\n      return ['admin', 'salesperson', 'pharmacy_admin'].includes(userRole.value)\r\n    })\r\n\r\n    const selectedMedicine = computed(() => {\r\n      return medicines.value.find(m => m.id === saleForm.medicine_id)\r\n    })\r\n\r\n    const getMaxQuantity = computed(() => {\r\n      return selectedMedicine.value ? selectedMedicine.value.stock : 0\r\n    })\r\n\r\n    const fetchSales = async () => {\r\n      try {\r\n        loading.value = true\r\n        await store.dispatch('sales/fetchSales')\r\n      } catch (error) {\r\n        ElMessage.error(error.message)\r\n      } finally {\r\n        loading.value = false\r\n      }\r\n    }\r\n\r\n    const fetchMedicines = async () => {\r\n      try {\r\n        await store.dispatch('medicines/fetchMedicines')\r\n      } catch (error) {\r\n        ElMessage.error(error.message)\r\n      }\r\n    }\r\n\r\n    const showAddDialog = () => {\r\n      console.log('显示添加销售记录对话框')\r\n      console.log('当前用户角色:', userRole.value)\r\n      console.log('可添加销售记录:', canAddSale.value)\r\n      console.log('药品列表:', medicines.value)\r\n      \r\n      // 重置表单数据\r\n      Object.assign(saleForm, {\r\n        medicine_id: '',\r\n        quantity: 1\r\n      })\r\n      dialogVisible.value = true\r\n      // 清除表单验证\r\n      setTimeout(() => {\r\n        if (saleFormRef.value) {\r\n          saleFormRef.value.clearValidate()\r\n        }\r\n      }, 100)\r\n    }\r\n\r\n    const handleDelete = async (row) => {\r\n      try {\r\n        await ElMessageBox.confirm('确定要删除这条销售记录吗？删除后将恢复对应的药品库存。', '警告', {\r\n          type: 'warning'\r\n        })\r\n        \r\n        const token = store.state.auth.token\r\n        const config = {\r\n          headers: {\r\n            'Authorization': `Bearer ${token}`\r\n          }\r\n        }\r\n        \r\n        await axios.delete(`http://localhost:5000/api/sales/${row.id}`, config)\r\n        ElMessage.success('删除成功，库存已恢复')\r\n        fetchSales()\r\n        fetchMedicines() // 刷新药品库存\r\n      } catch (error) {\r\n        if (error !== 'cancel') {\r\n          ElMessage.error(error.response?.data?.message || '删除失败')\r\n        }\r\n      }\r\n    }\r\n\r\n    const handleSubmit = async () => {\r\n      if (!saleFormRef.value) {\r\n        ElMessage.error('表单引用不存在')\r\n        return\r\n      }\r\n      \r\n      try {\r\n        // 验证表单\r\n        await saleFormRef.value.validate()\r\n        \r\n        // 检查必要数据\r\n        if (!saleForm.medicine_id) {\r\n          ElMessage.error('请选择药品')\r\n          return\r\n        }\r\n        \r\n        if (!saleForm.quantity || saleForm.quantity <= 0) {\r\n          ElMessage.error('请输入有效的数量')\r\n          return\r\n        }\r\n        \r\n        console.log('提交销售记录:', saleForm)\r\n        submitLoading.value = true\r\n        \r\n        // 设置请求头\r\n        const token = store.state.auth.token\r\n        if (!token) {\r\n          ElMessage.error('用户未登录')\r\n          return\r\n        }\r\n        \r\n        const config = {\r\n          headers: {\r\n            'Authorization': `Bearer ${token}`,\r\n            'Content-Type': 'application/json'\r\n          }\r\n        }\r\n        \r\n        const response = await axios.post('http://localhost:5000/api/sales', saleForm, config)\r\n        console.log('销售记录创建响应:', response.data)\r\n        \r\n        ElMessage.success('销售记录添加成功')\r\n        dialogVisible.value = false\r\n        await fetchSales()\r\n        await fetchMedicines() // 刷新药品库存\r\n      } catch (error) {\r\n        console.error('提交错误:', error)\r\n        if (error.response) {\r\n          console.error('错误响应:', error.response.data)\r\n          ElMessage.error(error.response.data?.message || '操作失败')\r\n        } else if (error.message) {\r\n          ElMessage.error(error.message)\r\n        } else {\r\n          ElMessage.error('请检查输入是否正确')\r\n        }\r\n      } finally {\r\n        submitLoading.value = false\r\n      }\r\n    }\r\n\r\n    onMounted(() => {\r\n      fetchSales()\r\n      fetchMedicines()\r\n    })\r\n\r\n    return {\r\n      loading,\r\n      sales,\r\n      medicines,\r\n      dialogVisible,\r\n      saleForm,\r\n      saleFormRef,\r\n      rules,\r\n      canAddSale,\r\n      canEditSale,\r\n      selectedMedicine,\r\n      getMaxQuantity,\r\n      showAddDialog,\r\n      handleDelete,\r\n      handleSubmit,\r\n      submitLoading\r\n    }\r\n  }\r\n}\r\n</script>\r\n\r\n<style scoped>\r\n.sales-container {\r\n  padding: 20px;\r\n}\r\n\r\n.header {\r\n  display: flex;\r\n  justify-content: space-between;\r\n  align-items: center;\r\n  margin-bottom: 20px;\r\n}\r\n\r\n.dialog-footer {\r\n  display: flex;\r\n  justify-content: flex-end;\r\n  gap: 10px;\r\n}\r\n\r\n:deep(.el-input-number) {\r\n  width: 100%;\r\n}\r\n\r\n:deep(.el-form-item__error) {\r\n  padding-top: 4px;\r\n}\r\n\r\n:deep(.el-select-dropdown__item.is-disabled) {\r\n  color: #c0c4cc;\r\n  cursor: not-allowed;\r\n}\r\n</style> "],"mappings":"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","ignoreList":[]}]}